var http = require('http');
var url  = require('url');
var qs   = require('querystring');
var csv  = require('csv');
var fs   = require('fs');

var sendgrid   = require('sendgrid')('sga7o8ih@kke.com', 'sasukene_aizu0');
var email      = new sendgrid.Email();


var zip_path = 'latlong.csv';
var zipcode = [];

// NCMB ’¥é’¥¤’¥Ö’¥é’¥ê
NCMB = require('./ncmb-latest.min.js').NCMB;
NCMB.initialize("ca1f3967db5fda719243b9ad9b53790fc14c106b7736b99c71ecccb774039e40", 
    "9418db7625f655dcfd5c7df625d8adeee48d6f9d7d565138f227c2632c85c6bb");


// ’Í¹’ÊØ’ÈÖ’¹æ’¤ò’Æþ’¼ê
fs.readFile( zip_path, function(err, sjisBuf) {
    //var buf = sjisBuf;
//    console.log( zip_path + '================');
//    csv.parse(sjisBuf.toString(),{comment:'#'}, function(err, data) {
    csv.parse( sjisBuf.toString(),{comment:'#'}, function(err, data) {
        console.log(err);       
        console.log(data.length);
        zipcode = data;

//        for( var jx = 0; jx < data.length; jx++ ){
//            console.log( data[jx][0], data[jx][1], data[jx][2]); 
//        }
    });
});


/**************************************/
// ’Å¬’µ¹’¥Æ’¡¼’¥Ö’¥ë’Ì¾’¤Ï’ÊÑ’¹¹’¿ô
/**************************************/
var SpotClass = NCMB.Object.extend("snow_location");

var query = new NCMB.Query(SpotClass);
var addData = new SpotClass();


/**************************************/
//mobile backend’¾å’¤Î’¥Ç’¡¼’¥¿’¸¡’º÷’¤ò’¼Â’¹Ô’¤¹’¤ë
/**************************************/
var server=http.createServer();

server.on('request',function(req,res){
    console.log(req.url);

    var urlInfo = url.parse(req.url);
    var pathname = urlInfo.pathname;

    switch(pathname){
        case '/search':
            ////////////////////
            // ’¸¡’º÷’ÍÑAPI
            ////////////////////
            var  lat = 37.5288585;      // ’Àß’Äê’¤¬’¤Ê’¤«’¤Ã’¤¿’»þ’¤Î’Âå’É½’¥Ý’¥¤’¥ó’¥È
            var  lng = 139.8990551;     // 

            if( req.method=='POST' ) {
                console.log( "POST" );
                // POST’¤Î’¾ì’¹ç
               var body = '';
               req.on('data', function (data) {
                   body +=data;
               });
               req.on('end',function(){
                   
                   var POST =  qs.parse(body);
                   console.log(POST);
               });
            }else if(req.method=='GET'){
                // GET’¤Î’¾ì’¹ç
                console.log( "GET" );

                var url_parts = url.parse(req.url,true);
                console.log(url_parts.query);

                // ’°Þ’ÅÙ’·Ð’ÅÙ’·¿’¤Ç’¤¢’¤ì’¤Ð’ÅÐ’Ï¿
                if( ( url_parts.query['lat'] != null ) && ( url_parts.query['long'] != null ) ){
                    lat = Number( url_parts.query['lat'] );
                    lng = Number( url_parts.query['long'] );
                    console.log( "idokeido", lat, lng );
                }else{
                // ’Í¹’ÊØ’ÈÖ’¹æ’¤Î’¾ì’¹ç
                    var localzipcode = 9650000;

                    if( url_parts.query['zipcode'] != null ){
                        console.log( url_parts.query['zipcode'] );
                        localzipcode = url_parts.query['zipcode'];

                        for( var jx = 0; jx < zipcode.length; jx++ ){
                            if( url_parts.query['zipcode'] == zipcode[ jx ][ 0 ]){
                                lat = parseFloat( zipcode[ jx ][ 1 ] );
                                lng = parseFloat( zipcode[ jx ][ 2 ] );
                                console.log( lat, lng );
                                break;
                            }
                        }
                    }

                    // ’¥á’¡¼’¥ë’Á÷’¿®
                    if( url_parts.query['zipcode'] == 9650817 ){
                        email.setTos("yaritsusozai@gmail.com");
                        email.setFrom("info@sasukene.jp");
                        email.setSubject('’½Ð’¿Ø’°Í’Íê’¡ª');
                        email.setText('’·¯’¤Î’¥¨’¥ê’¥¢’¤Ë’¡¢’½õ’¤±’¤ò’µá’¤á’¤ë’Ä®’Ì±’¤¬’¤¤’¤ë’¤¾’¡ª’¤¤’¤¶’¡¢’Àã’¤«’¤­’¤Ë’½Ð’Æ°’¤¸’¤ã’¡ª');
                         
                        sendgrid.send(email, function(err, json) {
                          if (err) { return console.error(err); }
                          console.log(json);
                        });
                    }
                }
            }

            /******************/
            // ’ÊÖ’µÑ’Éô’Ê¬
            /******************/
            res.writeHead(200, { 'Content-Type': 'application/json' });
            //’°Ì’ÃÖ’¾ð’Êó’¤ò’¤â’¤È’¤Ë’¸¡’º÷’¤¹’¤ë’¾ò’·ï’¤ò’Àß
            var geoPoint = new NCMB.GeoPoint(lat,lng);
            // ’¥¯’¥¨’¥ê’¡¼’¤Î’¾ò’·ï’¤ò’·è’¤á’¤ë
            query.withinKilometers("geo", geoPoint, 5);
            //query.equalTo("status", 0 );
            query.greaterThan("Date", retDateValue( -12 ) );
            
            query.find({
                success: function(points) {
                    //$("#result").html("");
                    // ’¸¡’º÷’¤¬’À®’¸ù’¤·’¤¿’¾ì’¹ç’¤Î’½è’Íý
                    var data = [];

                    console.log( points.length );
                    for (var i = 0; i < points.length; i++){
                        var point = points[i];
                        //console.log( "’¥¹’¥Ý’¥Ã’¥È’Ì¾’¡§" + point.get("name") );

                        data.push({
                            objectId: point.get("objectId"),
                            geo     : point.get("geo"),
                            kind    : point.get("kind"),
                            status  : point.get("status"),
                            date    : point.get("updateDate")
                        });

                    }
                    console.log( JSON.stringify(data) );
                    res.end( JSON.stringify(data) );
                },
                error: function(error) {
                    // ’¸¡’º÷’¤Ë’¼º’ÇÔ’¤·’¤¿’¾ì’¹ç’¤Î’½è’Íý
                    console.log(error.message);
                    res.end(JSON.stringify({ 'err': 'err' }));

                }
            });
            break;
        case '/add':
            /////////////////////
            // ’ÄÉ’²Ã’ÅÐ’Ï¿
            /////////////////////
            console.log( "add" );
            console.log( req.method );
            var addData = new SpotClass();
            
            if(req.method=='GET'){
                // GET’¤Î’¾ì’¹ç
                console.log( "GET" );

                var url_parts = url.parse(req.url,true);
                console.log(url_parts.query);

                if( ( url_parts.query['lat'] != null ) && ( url_parts.query['long'] != null ) &&
                    ( url_parts.query['kind'] != null ) ){
                    ////////////////////////
                    // ’°Þ’ÅÙ’·Ð’ÅÙ’¤Ë’¤è’¤ë’ÅÐ’Ï¿
                    ////////////////////////
                    var lat = Number( url_parts.query['lat'] );
                    var lng = Number( url_parts.query['long'] );
                    var geo_str = new NCMB.GeoPoint({latitude: lat, longitude: lng})
                    var status  = 0;
                    addData.set("geo", geo_str );
                    addData.set("status", status );
                    addData.set("Date", retDateValue( 0 ) );
                    addData.set("kind", Number(url_parts.query['kind']));
                    addData.save(null, {
                        success: function(addData) {
                            // ’ÊÝ’Â¸’´°’Î»’¸å’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                            console.log("New object created with objectId: " + addData.id);
                        },
                        error: function(addData, error) {
                            // ’¥¨’¥é’¡¼’»þ’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                            console.log("Failed to create new object, with error code: " + error.message);
                        }
                    });


                    console.log( url_parts.query['lat'], url_parts.query['long'], url_parts.query['kind'] );
                }else’¡¡if( ( url_parts.query['zipcode'] != null ) && ( url_parts.query['kind'] != null ) ){
                    console.log( url_parts.query['zipcode'], url_parts.query['kind'] );
                    //////////////////////////
                    // ’Í¹’ÊØ’ÈÖ’¹æ’¤Î’¾ì’¹ç
                    //////////////////////////
                    var localzipcode = 9650000;

                    if( url_parts.query['zipcode'] != null ){
                        console.log( url_parts.query['zipcode'] );
                        localzipcode = url_parts.query['zipcode'];

                        var  jx;
                        for( jx = 0; jx < zipcode.length; jx++ ){
                            if( url_parts.query['zipcode'] == zipcode[ jx ][ 0 ]){
                                lat = parseFloat( zipcode[ jx ][ 1 ] );
                                lng = parseFloat( zipcode[ jx ][ 2 ] );
                                console.log( lat, lng );
                                break;
                            }
                        }

                        // ’¸«’¤Ä’¤«’¤ì’¤Ð’ÅÐ’Ï¿’¤¹’¤ë
                        if( jx != zipcode.length ){
                            var lat = Number( lat’¡¡);
                            var lng = Number( lng );
                            var geo_str = new NCMB.GeoPoint({latitude: lat, longitude: lng})
                            var status  = 0;
                            addData.set("geo", geo_str );
                            addData.set("status", status );
                            addData.set("Date", retDateValue( 0 ) );
                            addData.set("kind", Number(url_parts.query['kind']));
                            addData.save(null, {
                                success: function(addData) {
                                    // ’ÊÝ’Â¸’´°’Î»’¸å’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                                    console.log("New object created with objectId: " + addData.id);
                                },
                                error: function(addData, error) {
                                    // ’¥¨’¥é’¡¼’»þ’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                                    console.log("Failed to create new object, with error code: " + error.message);
                                }
                            });
                        }
                    }

                }else{
                    // ’Â­’¤ê’¤Ê’¤¤’¤Î’¤Ç’¡¢’¥Ç’¡¼’¥¢’½Ð’ÎÏ’¤·’¤Ê’¤¤
                    console.log( "add error" )
                }


            }else if(req.method=='POST'){
                console.log( 'post' );
                var url_parts = url.parse(req.url,true);
                console.log(url_parts.query);

                /////////////////
                // post
                /////////////////
                var body = '';
                req.on('data', function (data) {
                   body +=data;
                });
                req.on('end',function(){
                   var POST =  qs.parse(body);
                   console.log(POST);
                });

            }

            res.end(JSON.stringify({ 'add': '' }));
            break;
        case '/update':
            /////////////////////
            // ’ÄÉ’²Ã’ÅÐ’Ï¿
            /////////////////////
            console.log( "test" );
            var addData = new SpotClass();
            
            if(req.method=='GET'){
                // GET’¤Î’¾ì’¹ç
                console.log( "GET" );

                var url_parts = url.parse(req.url,true);
                console.log(url_parts.query);

                if( ( url_parts.query['lat'] != null ) && ( url_parts.query['long'] != null )  && ( url_parts.query['kind'] != null ) ){
                    ////////////////////////
                    // ’°Þ’ÅÙ’·Ð’ÅÙ’¤Ë’¤è’¤ë’ÅÐ’Ï¿
                    ////////////////////////
                    var lat = Number( url_parts.query['lat'] );
                    var lng = Number( url_parts.query['long'] );
                    var geo_str = new NCMB.GeoPoint({latitude: lat, longitude: lng})
                    var status  = 1;
                    addData.set("geo", geo_str );
                    addData.set("status", status );
                    addData.set("Date", retDateValue( 0 ) );
                    addData.set("kind", Number(url_parts.query['kind']));
                    addData.save(null, {
                        success: function(addData) {
                            // ’ÊÝ’Â¸’´°’Î»’¸å’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                               console.log("update with objectId: " + addData.id);
                        },
                        error: function(addData, error) {
                            // ’¥¨’¥é’¡¼’»þ’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                            console.log("Failed to update, with error code: " + error.message);
                        }
                    });


                    console.log( url_parts.query['lat'], url_parts.query['long'], url_parts.query['kind'] );
                }else’¡¡if( ( url_parts.query['zipcode'] != null ) &6 ( url_parts.query['kind'] != null )  ){
                    console.log( url_parts.query['zipcode'] );
                    //////////////////////////
                    // ’Í¹’ÊØ’ÈÖ’¹æ’¤Î’¾ì’¹ç
                    //////////////////////////
                    var localzipcode = 9650000;

                    if( url_parts.query['zipcode'] != null ){
                        console.log( url_parts.query['zipcode'] );
                        localzipcode = url_parts.query['zipcode'];

                        var  jx;
                        for( jx = 0; jx < zipcode.length; jx++ ){
                            if( url_parts.query['zipcode'] == zipcode[ jx ][ 0 ]){
                                lat = parseFloat( zipcode[ jx ][ 1 ] );
                                lng = parseFloat( zipcode[ jx ][ 2 ] );
                                console.log( lat, lng );
                                break;
                            }
                        }

                        // ’¸«’¤Ä’¤«’¤ì’¤Ð’ÅÐ’Ï¿’¤¹’¤ë
                        if( jx != zipcode.length ){
                            var lat = Number( lat’¡¡);
                            var lng = Number( lng );
                            var geo_str = new NCMB.GeoPoint({latitude: lat, longitude: lng})
                            var status  = 1;
                            addData.set("geo", geo_str );
                            addData.set("status", status );
                            addData.set("Date", retDateValue( 0 ) );
                            addData.set("kind", Number(url_parts.query['kind']));
                            addData.save(null, {
                                success: function(addData) {
                                    // ’ÊÝ’Â¸’´°’Î»’¸å’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                                    console.log("update with objectId: " + addData.id);
                                },
                                error: function(addData, error) {
                                    // ’¥¨’¥é’¡¼’»þ’¤Ë’¼Â’¹Ô’¤µ’¤ì’¤ë
                                    console.log("Failed to update object, with error code: " + error.message);
                                }
                            });
                        }
                    }

                }else{
                    // ’Â­’¤ê’¤Ê’¤¤’¤Î’¤Ç’¡¢’¥Ç’¡¼’¥¢’½Ð’ÎÏ’¤·’¤Ê’¤¤
                    console.log( "update error" )
                }


            }
            break;
    }
}).listen(3000);
console.log('Server is starting');

/**************************************/
// ’»þ’´Ö’¤ò’ÊÖ’¤¹’´Ø’¿ô
/**************************************/
function retDateValue( sabun ){
    var dateObj = new Date(); //’¸½’ºß’¤Î’Æü’ÉÕ’¤È’»þ’´Ö’¤ÎdateObj’À¸’À®
    var mm = dateObj.getMonth(); 
    var dd = dateObj.getDate();
    var hh = dateObj.getHours();
    var x = sabun; // 26’»þ’´Ö’¸å 
    dateObj.setTime(dateObj.getTime() + (x * 3600 * 1000));
    var mm_x = dateObj.getMonth() + 1; 
    var dd_x = dateObj.getDate();
    var hh_x = dateObj.getHours();

    var timestr = dateObj.getYear() + 1900 + ("0" + mm_x ).slice(-2) + ("0" + dd_x ).slice(-2)
                + ("0" + hh_x ).slice(-2) + ("0" + dateObj.getMinutes() ).slice(-2)
                + ("0" + dateObj.getSeconds() ).slice(-2);

    return Number( timestr );
}

